FROM docker.io/node:20-alpine AS base

RUN apk update
RUN npm install -g turbo

WORKDIR /app

FROM base AS config

WORKDIR /config

COPY . .

RUN turbo prune @repo/config --docker

WORKDIR /app

RUN mv /config/out/json/* .
RUN mv /config/out/package-lock.json .

RUN npm install

RUN rm -rf apps packages
RUN mv /config/out/full/* .

RUN mv /config/packages/container/config.json .

RUN rm -rf /config

WORKDIR /app/apps/config

RUN npm run config:cli docker

WORKDIR /app

FROM base AS builder

COPY . .

RUN turbo prune @repo/cluster --docker

FROM base AS installer

COPY --from=builder /app/out/json .
COPY --from=builder /app/out/package-lock.json ./package-lock.json

RUN npm install

COPY --from=builder /app/out/full .
COPY --from=config /app/apps/cluster/.config.json /app/apps/cluster/.config.json

RUN turbo run build --filter=cluster

FROM base AS runner

RUN addgroup --system --gid 1001 cluster
RUN adduser --system --uid 1001 cluster

RUN chown -R cluster:cluster /app

USER cluster

COPY --from=installer --chown=cluster:cluster /app/node_modules/ ./node_modules/

COPY --from=installer --chown=cluster:cluster /app/apps/cluster/dist/index.js .

CMD ["node", "index.js"]

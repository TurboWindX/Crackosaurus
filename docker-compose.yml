services:
  database:
    container_name: database
    image: docker.io/postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    networks:
      - app
    volumes:
      - pgdata:/var/lib/postgresql/data
  prisma:
    container_name: prisma
    restart: on-failure
    build:
      context: .
      dockerfile: packages/container/prisma/Containerfile
      args:
        DATABASE_PROVIDER: postgresql
    environment:
      DATABASE_PATH: postgresql://postgres:postgres@database:5432/crackosaurus?schema=public
    networks:
      - app
    depends_on:
      - database
  instance:
    container_name: instance
    restart: always
    build:
      context: .
      dockerfile: packages/container/instance/docker/Containerfile
    environment:
      INSTANCE_ID: docker
      INSTANCE_ROOT: /crackodata/instances
      WORDLIST_ROOT: /crackodata/wordlists
    user: 0:0
    networks:
      - app
    volumes:
      - instances:/crackodata/instances
      - wordlists:/crackodata/wordlists
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities:
                - gpu
  cluster:
    container_name: cluster
    restart: always
    build:
      context: .
      dockerfile: packages/container/cluster/Containerfile
      args:
        CLUSTER_PORT: 13337
    environment:
      CLUSTER_HOST: cluster
      CLUSTER_TYPE: external
      CLUSTER_INSTANCE_ROOT: /crackodata/instances
      CLUSTER_WORDLIST_ROOT: /crackodata/wordlists
    user: 0:0
    networks:
      - app
    volumes:
      - instances:/crackodata/instances
      - wordlists:/crackodata/wordlists
  server:
    container_name: server
    restart: always
    build:
      context: .
      dockerfile: packages/container/server/Containerfile
      args:
        DATABASE_PROVIDER: postgresql
        BACKEND_HOST: USE_WEB_HOST
        BACKEND_PORT: 8080
    environment:
      WEB_HOST: localhost
      WEB_PORT: 8080
      CLUSTER_HOST: cluster
      CLUSTER_PORT: 13337
      # Provide a backend secret via environment or an .env file. Do NOT commit real secrets.
      BACKEND_SECRET: "${BACKEND_SECRET:-change-me}"
      DATABASE_PATH: postgresql://postgres:postgres@database:5432/crackosaurus?schema=public
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: us-east-1
      AWS_ENDPOINT_URL: http://localstack:4566
      S3_PUBLIC_ENDPOINT_URL: http://localhost:4566
      # S3_BUCKET_NAME will be auto-generated if not specified (crackosaurus-{random})
    ports:
      - "8080:8080"
    networks:
      - app
    depends_on:
      - cluster
      - database
      - localstack

  localstack:
    container_name: localstack
    image: localstack/localstack:latest
    ports:
      - "4566:4566"            # LocalStack Gateway
      - "4510-4559:4510-4559"  # external services port range
    environment:
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - SERVICES=s3
      - INIT_SCRIPTS_PATH=/etc/localstack/init/ready.d
      - EXTRA_CORS_ALLOWED_ORIGINS=http://localhost:8080
      - EXTRA_CORS_ALLOWED_HEADERS=*
    volumes:
      - localstack_data:/var/lib/localstack
      - "/var/run/docker.sock:/var/run/docker.sock"
      - ./localstack:/etc/localstack/init/ready.d
    networks:
      - app

networks:
  app:
    driver: bridge

volumes:
  instances:
  pgdata:
  wordlists:
  localstack_data:
